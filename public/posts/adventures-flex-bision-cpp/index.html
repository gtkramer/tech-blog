<!DOCTYPE html>

<html lang="en-us">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>Adventures Using Flex and Bison with C&#43;&#43; | Tech Blog</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="http://example.org/css/main.min.63808615fc62cbc530414bd85d9c94ae4e989425ab018a75e3aab4f6a3fe4d20.css"/>

    
    
    

    
    
 
    </head>

    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="/">Tech Blog</a>
    </div>  
</header>

  <div class="nav-menu">
  
    <a class="color-link nav-link" href="/about/">About</a>
  
    <a class="color-link nav-link" href="/tags/">Tags</a>
  
  <a class="color-link nav-link" href="http://example.org/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    
    <a class="social-icon" href="https://www.linkedin.com/in/george-kramer-3816691a6" target="_blank" rel="noopener" title="LinkedIn">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M2,3.654102 C2,2.69908141 2.79442509,1.92397846 3.77383592,1.92397846 L24.2261641,1.92397846 C25.2058917,1.92397846 26,2.69908141 26,3.654102 L26,24.3462148 C26,25.3015521 25.2058917,26.0760215 24.2261641,26.0760215 L3.77383592,26.0760215 C2.79442509,26.0760215 2,25.3015521 2,24.3465315 L2,3.65378524 L2,3.654102 Z M9.27526132,22.1415901 L9.27526132,11.2356668 L5.65030092,11.2356668 L5.65030092,22.1415901 L9.27557808,22.1415901 L9.27526132,22.1415901 Z M7.46341463,9.74691162 C8.72727273,9.74691162 9.51409566,8.90940767 9.51409566,7.86284447 C9.49033893,6.79252455 8.72727273,5.97846056 7.48748812,5.97846056 C6.24675325,5.97846056 5.43649034,6.79252455 5.43649034,7.86284447 C5.43649034,8.90940767 6.22299652,9.74691162 7.4396579,9.74691162 L7.46309788,9.74691162 L7.46341463,9.74691162 Z M11.2815965,22.1415901 L14.9062401,22.1415901 L14.9062401,16.0519481 C14.9062401,15.7263225 14.9299968,15.4000634 15.0256573,15.1675641 C15.2876148,14.5159962 15.8840672,13.8416218 16.8856509,13.8416218 C18.1970225,13.8416218 18.7218879,14.8416218 18.7218879,16.3078872 L18.7218879,22.1415901 L22.3465315,22.1415901 L22.3465315,15.8885017 C22.3465315,12.5388027 20.5584416,10.9800443 18.1735825,10.9800443 C16.2182452,10.9800443 15.3595185,12.072854 14.8824834,12.8172315 L14.9065569,12.8172315 L14.9065569,11.2359835 L11.2819132,11.2359835 C11.3291099,12.2591067 11.2815965,22.1419069 11.2815965,22.1419069 L11.2815965,22.1415901 Z"></path>
        </svg>
    </a>
    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="https://github.com/gtkramer" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

    

</div>




	<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="http://example.org/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww=" crossorigin="anonymous"></script>
</footer>
</nav>

        <div id="content" class="content-container">
        

<h1 class="post-title">Adventures Using Flex and Bison with C&#43;&#43;</h1>
    
    <time>January 13, 2018</time>
    
    <div>
        <p>
        <h2 id="motivation-and-goal">Motivation and Goal</h2>
<p>The compilers class I took as an undergraduate at the University of Connecticut is the most challenging yet one of the most interesting classes I have ever taken.  The project-driven class gave students hands-on experience with writing a compiler by breaking the large task into smaller tasks over the course of the semester.  Specifically, we needed to write a compiler that translates C--, a simple subset of C, to LLVM IR.  From there, we used the LLVM toolchian to finish compiling C-- to machine code.</p>
<p>To help with the scanner and the parser bits that are essential to any compiler, we used the GNU tools flex and bison.  These are time-tested text-processing programs known for not requiring any additional runtime or build requirements for the code they generate.  In this sense, the code they generate for doing the actual text processing is portable.  These text-processing programs are also mature with many years of development behind them, which makes them not a bad choice.</p>
<p>I wanted to revisit my knowledge of flex and bison with <a href="https://github.com/gtkramer/ScaffoldingGenerator">a program</a> I&rsquo;m developing outside of work.  The goal of the program is to generate the scaffolding for a model before everything is 3D printed and to provide a means for graphically interacting with the computed result.  The model is given to the program in the form of either a text or binary STL file.  I wanted to see if I could write a C++ parser for a text STL file using flex and bison.  The syntax for a text STL file is very simple.  It&rsquo;s given below:</p>
<div class="highlight"><pre class="chroma"><code class="language-plain" data-lang="plain">solid name
	facet normal ni nj nk
		outer loop
			vertex v1x v1y v1z
			vertex v2x v2y v2z
			vertex v3x v3y v3z
		endloop
	endfacet
endsolid name
</code></pre></div><p>I became interested in the C++ interface for flex and bison because I wanted to use the vector container from the Standard Template Library to read text STL files as streams.  Previous versions of bison used a union interface which only allows tokens and semantic values to be defined with trivial data types (unless pointers are used).  Bison 3.0 introduced a variant interface which allows complex data types to be used.  Suddenly, it was possible to define tokens and semantic values as follows:</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="o">%</span><span class="n">token</span> <span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span> <span class="n">FLOAT</span>
<span class="o">%</span><span class="n">type</span> <span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span> <span class="mi">3</span><span class="o">&gt;</span><span class="p">,</span> <span class="mi">4</span><span class="o">&gt;&gt;</span> <span class="n">facet</span>
</code></pre></div><p>These are natural definitions analogous to the structure of the STL file format.  I figured I would try to get on board with the variant interface in conjunction with the C++ interface for flex and bison.  While I was at it, I wanted to see if I could also make a pure (reentrant) scanner and parser.</p>
<h2 id="bison-c-thoughts">Bison C++ Thoughts</h2>
<p>I began looking through the GNU documentation for guidance on how to use the variant and C++ interfaces with bison.  I found <a href="https://www.gnu.org/software/bison/manual/html_node/Calc_002b_002b-Parser.html">a complete C++ example</a> to help me get going.</p>
<p>After getting going, I ran into the same uncomfortable usage of bison that I remember seeing back when I was taking my compilers class.  Code is mixed with declarative syntax in different sections.  To configure bison in a good manner and to use the variant and C++ interfaces, the following declarations are required:</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="o">%</span><span class="n">skeleton</span> <span class="s">&#34;lalr1.cc&#34;</span>
<span class="o">%</span><span class="n">require</span> <span class="s">&#34;3.5&#34;</span>
<span class="o">%</span><span class="n">defines</span>
<span class="o">%</span><span class="n">define</span> <span class="n">api</span><span class="p">.</span><span class="n">token</span><span class="p">.</span><span class="n">constructor</span>
<span class="o">%</span><span class="n">define</span> <span class="n">api</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">type</span> <span class="n">variant</span>
<span class="o">%</span><span class="n">define</span> <span class="n">parse</span><span class="p">.</span><span class="n">assert</span>
</code></pre></div><p>For grammar actions to use the Standard Template Library, they need to have detailed knowledge about the driver, which orchestrates the parsing from the main program.  But the generated parser code also needs to have detailed knowledge of the driver.  This requires the following code:</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="o">%</span><span class="n">code</span> <span class="k">requires</span> <span class="p">{</span>
    <span class="cp">#include</span> <span class="cpf">&lt;array&gt;</span><span class="cp">
</span><span class="cp"></span>    <span class="cp">#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp">
</span><span class="cp"></span>    <span class="k">class</span> <span class="nc">StlTextDriver</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">%</span><span class="n">code</span> <span class="p">{</span>
    <span class="cp">#include</span> <span class="cpf">&#34;StlTextDriver.h&#34;</span><span class="cp">
</span><span class="cp"></span><span class="p">}</span>
</code></pre></div><p>Needing to worry about this circular dependency as a part of the grammar definition feels like an extra step.  And needing to define options to assert proper usage of the variant interface and to fully benefit from type safety also feels like an extra step.  It made me begin questioning whether I wanted to continue using bison (and therefore flex) for the program I&rsquo;m developing outside of work.  But I wanted to see this through, so I moved on to take a look at flex.</p>
<h2 id="flex-c-challenges">Flex C++ Challenges</h2>
<p>As with bison, I looked through the GNU documentation for guidance on how to use the C++ interface with flex with the same <a href="https://www.gnu.org/software/bison/manual/html_node/Calc_002b_002b-Scanner.html#Calc_002b_002b-Scanner">complete C++ example</a>.  I found some <a href="https://ftp.gnu.org/old-gnu/Manuals/flex-2.5.4/html_node/flex_19.html">additional GNU documentation</a> to be particularly useful here.</p>
<p>To use the C++ interface of flex, the following declaration is required:</p>
<div class="highlight"><pre class="chroma"><code class="language-C++" data-lang="C++"><span class="o">%</span><span class="n">option</span> <span class="n">c</span><span class="o">++</span>
</code></pre></div><p>When I tried to compile the generated scanner code, I received an error about a missing definition of <code>YY_NULLPTR</code>.  This looked like a bug in flex to me.  To work around it, I defined it manually in a manner consistent with the C++11 standard:</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#ifndef YY_NULLPTR
</span><span class="cp"></span>	<span class="cp">#define YY_NULLPTR nullptr
</span><span class="cp">#endif
</span></code></pre></div><p>Out of curiosity, I decided to take a look at the generated scanner code.  To my surprise, I was immediately greeted with the following message:</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cm">/* The c++ scanner is a mess. The FlexLexer.h header file relies on the
</span><span class="cm">* following macro. This is required in order to pass the c++-multiple-scanners
</span><span class="cm">* test in the regression suite. We get reports that it breaks inheritance.
</span><span class="cm">* We will address this in a future release of flex, or omit the C++ scanner
</span><span class="cm">* altogether.
</span><span class="cm">*/</span>
</code></pre></div><p><em>giggle</em></p>
<p>It seems that the C++ interface for flex is still under active development and needs more work.  While at the end of the day it was a comical reminder that no software is perfect, it didn&rsquo;t get me closer to confidently achieving my goal.  It made me further question whether I wanted to continue using flex and bison.</p>
<h2 id="last-ditch-effort">Last Ditch Effort</h2>
<p>At this point, I wasn&rsquo;t sure I was using flex and bison correctly.  I still didn&rsquo;t have a working pure scanner and parser for a text STL file.  I wanted to see if I could find other examples to help me out, given the GNU documentation wasn&rsquo;t getting me very far.</p>
<p>I found additional complete examples of the C++ interface for flex and bison.  One was from <a href="http://www.jonathanbeard.io/tutorials/FlexBisonC++">jonathanbeard</a> and another was from <a href="https://github.com/ezaquarii/bison-flex-cpp-example">ezaquarii</a>.  These seem to be the only two complete and reliable examples in existence (sarcastically, although only partially) that have enough explanation around them to justify using them as a reference.</p>
<p>The problem with these examples is that they approach the problem slightly differently.  Sure, I could say that I like jonathanbeard&rsquo;s implementation better because I can understand it better and because the documentation is better.  But that didn&rsquo;t mean it was a best known method.  I need a tie-breaker of sorts to help me determine a best known method.</p>
<h2 id="nail-in-the-coffin">Nail in the Coffin</h2>
<p>I took a look at what technical literature had to say about flex and bison.  O&rsquo;Rielly is a respected technical publisher. I see many of their books at my workplace on the shelves of my coworkers.  Their book <em>Flex and Bison</em> was published in 2009, which is a little dated, but maybe not so bad given the rate at which these tools change.  After reading through a couple of the chapters, I found some telling commentary:</p>
<blockquote>
<p>Unfortunately, as of the time this book went to press (mid-2009), the code for flex pure scanners and yacc pure scanners is a mess. Bison’s calling sequence for a pure yylex() is different from flex’s, and the way they handle per-instance data is different. It’s possible to paper over the problems in the existing code and persuade pure scanners and parsers to work together, which is what we will do in this chapter, but before doing so, check the latest flex and bison documentation.</p>
</blockquote>
<blockquote>
<p>As should be apparent by now, the C++ support in bison is nowhere near as mature as the C support, which is not surprising since it’s about 30 years newer.</p>
</blockquote>
<p>It would appear that my struggle with finding good documentation was dwarfed by the unfortunate state of the implementation of the C++ interface for flex and bison.  It explains the difficulty I have been having up until this point.</p>
<h2 id="where-to-now">Where to Now?</h2>
<p>Given this is where I had arrived, I decided to completely drop flex and bison and look for a different solution for constructing a pure scanner and parser for a text STL file.  I didn&rsquo;t want to drop a parsing solution altogether and just use regular expressions because they are not the easiest to maintain, and they are more error-prone than using tools that guarantee good use.</p>
<p>I am interested in a solution that is designed to seamlessly integrate with C++, that maybe doesn&rsquo;t have awkward code generation bits, and that has matured nicely over the years.</p>
<p>Nonetheless, all I have left to say about flex and bison is, it&rsquo;s been fun.  So long, farewell, auf wiedersehen, goodbye, flex and bison!</p>

        </p>
    </div>
    

    

    <div class="page-footer">
        
    </div>


        
        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    
    <a class="social-icon" href="https://www.linkedin.com/in/george-kramer-3816691a6" target="_blank" rel="noopener" title="LinkedIn">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M2,3.654102 C2,2.69908141 2.79442509,1.92397846 3.77383592,1.92397846 L24.2261641,1.92397846 C25.2058917,1.92397846 26,2.69908141 26,3.654102 L26,24.3462148 C26,25.3015521 25.2058917,26.0760215 24.2261641,26.0760215 L3.77383592,26.0760215 C2.79442509,26.0760215 2,25.3015521 2,24.3465315 L2,3.65378524 L2,3.654102 Z M9.27526132,22.1415901 L9.27526132,11.2356668 L5.65030092,11.2356668 L5.65030092,22.1415901 L9.27557808,22.1415901 L9.27526132,22.1415901 Z M7.46341463,9.74691162 C8.72727273,9.74691162 9.51409566,8.90940767 9.51409566,7.86284447 C9.49033893,6.79252455 8.72727273,5.97846056 7.48748812,5.97846056 C6.24675325,5.97846056 5.43649034,6.79252455 5.43649034,7.86284447 C5.43649034,8.90940767 6.22299652,9.74691162 7.4396579,9.74691162 L7.46309788,9.74691162 L7.46341463,9.74691162 Z M11.2815965,22.1415901 L14.9062401,22.1415901 L14.9062401,16.0519481 C14.9062401,15.7263225 14.9299968,15.4000634 15.0256573,15.1675641 C15.2876148,14.5159962 15.8840672,13.8416218 16.8856509,13.8416218 C18.1970225,13.8416218 18.7218879,14.8416218 18.7218879,16.3078872 L18.7218879,22.1415901 L22.3465315,22.1415901 L22.3465315,15.8885017 C22.3465315,12.5388027 20.5584416,10.9800443 18.1735825,10.9800443 C16.2182452,10.9800443 15.3595185,12.072854 14.8824834,12.8172315 L14.9065569,12.8172315 L14.9065569,11.2359835 L11.2819132,11.2359835 C11.3291099,12.2591067 11.2815965,22.1419069 11.2815965,22.1419069 L11.2815965,22.1415901 Z"></path>
        </svg>
    </a>
    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="https://github.com/gtkramer" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="http://example.org/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww=" crossorigin="anonymous"></script>
</footer>
    </body>
</html>